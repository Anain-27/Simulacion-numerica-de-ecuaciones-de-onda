% !TeX encoding = ISO-8859-1

\chapter{Resolución numérica de la ecuación de onda}
\label{cha:Diferenciasfinitas}

\section{Métodos principales de resolución}

Las ecuaciones en derivadas parciales, en general, no se pueden resolver con métodos exactos, como separación de variables, transformada de Fourier, etc. Con la excepción de ecuaciones muy sencillas sobre dominios espaciales no acotados o muy estructurados, como intervalos, rectángulos o esferas,que en la practica pueden no resultar útiles para capturar todos los matices de la realidad. Esto nos lleva a la creación de métodos numéricos que consiguen resolverlas de una manera aproximada,pero con errores tan pequeños como sea preciso siempre que podamos asumir el coste computacional.\\

En este apartado nos centraremos en el método de diferencias finitas, y veremos las características principales que nos atañen del mismo. Más tarde, en el capítulo 5, implementaremos este método en Python.

\section{Método de diferencias finitas}

Este método consiste principalmente en el uso de cocientes incrementales para la aproximación en tiempo y en espacio de nuestro problema de contorno con valores iniciales para la ecuación de onda \eqref{ecuaciononda},\eqref{eq:frontera1},\eqref{eq:frontera2},\eqref{eq:frontera3}.
Vamos a crear un mallado tal y como en \ref{Mallado}, para hacer una discretización del problema.

$$\begin{array}{lcc}   
	x_j=jh & para &  j=1,\dots,m, \\
	\\t_r = rk & para & r=0,1,\dots,n.
\end{array} $$

En este caso elegimos un entero m y el tamaño de paso de tiempo correspondiente $k>0$. El tamaño de paso del espacio será $h=\frac{l}{m}$ y con esto haremos un mallado del tipo $(x_j,t_r)$.\\

Vemos que los puntos $(x_j,t_r)$ del interior del dominio espacio temporal podrían escribirse como:
\begin{equation}\label{eq:ondaxt}
	u_{tt}(x_j,t_r)=c^2u_{xx}(x_j,t_r).
\end{equation}

En lo que sigue, nos propondremos calcular un conjunto de valores, denotados $u_{j,r}\in \mathbb{R}$ que verifiquen de forma aproximada la igualdad anterior , $u(x_j,t_r)\approx u_{j,r}$.\\
 Para ello el método se construirá optando por un esquema del tipo explícito en espacio, utilizando una aproximación centrada tanto en espacio como en tiempo.

\begin{equation}\label{eq:aprox1}
 u_{xx}(x_j,t_r) \approx \frac{u_{j+1,r} - 2u_{j,r} +u_{j-1,r}}{h^2},
\end{equation}

\begin{equation}\label{eq:aprox2}
	 u_{tt}(x_j,t_r) \approx \frac{u_{j,r+1} - 2u_{j,r} +u_{j,r-1}}{k^2}.
\end{equation}

Ahora sustituyendo las expresiones \eqref{eq:aprox1},\eqref{eq:aprox2} en la ecuación de onda \eqref{eq:ondaxt} nos queda el esquema.
\begin{equation}\label{eq:ondametodo}
	\frac{u_{j,r+1} - 2u_{j,r} +u_{j,r-1}}{k^2} = c^2 \frac{u_{j+1,r} - 2u_{j,r} +u_{j-1,r}}{h^2}.
\end{equation} 

Es usual definir $\mu  = \frac{ck}{h}$, con lo que se tendría:

$$ u_{j,r+1} - 2u_{j,r} +u_{j,r-1} = \mu ^2 u_{j+1,r} - 2 \mu^2 u_{j,r} +\mu u_{j-1,r},$$

$$  \text{para} \ \ \  r=1,2,\dots, n,\ \ j=1,2,\dots, m-1.$$


Despejando la aproximación con mayor nivel en tiempo, obtenemos:

\begin{equation}\label{eq:ondadespejado}
	u_{j,r+1} = \mu ^2( u_{j+1,r}+u_{j-1,r})  + 2(1-\mu^2)  u_{j,r} -  u_{j,r-1}.
\end{equation}
Esta expresión define el método que utilizaremos, dejando a un lado las condiciones de contorno \eqref{eq:frontera1},\eqref{eq:frontera2} y \eqref{eq:frontera3}.\\

A continuación nos centraremos en dichas condiciones, siguiendo \citep{strauss}.En primer lugar la condición inicial \eqref{eq:frontera1} nos dará los valores de los nodos 
 \begin{equation*}
 	\begin{array}{lcr}
 		u_{j,0}=f(x_j), & \text{    para    } & j=0,1,\dots,m.
 	\end{array}
 \end{equation*}
 
  Por otra parte, las condiciones de tipo Dirichlet \eqref{eq:frontera3} quedarán como $u_{0,r}=u_{m,r}=0 $ para $r=0,1,\dots,n$.\\
  
  Para la condición que falta \eqref{eq:frontera2} utilizaremos, haciendo una aproximación por cociente incremental en los dos primeros instantes, $u_{j,1}=u_{j,0}+k g(x_j)$, que servirá ya sean las $f$ y $g$ derivables o no. Para esta podría haber muchas mas opciones. En nuestro caso no ahondaremos mas en este tema y utilizaremos la expresión mas sencilla descrita anteriormente.\\
  
Nuestro esquema al completo quedaría:

\begin{equation}\label{esquemacompletoonda}
	u_{j,r+1} = \mu ^2( u_{j+1,r}+u_{j-1,r})  + 2(1-\mu^2)  u_{j,r} -u_{j,r-1},
\end{equation} 
\begin{equation}\label{eq:esquemafrontera1}
	\begin{array}{lc}   
			u_{j,0}=f(x_j), &   j=0,1,\dots,m,
	\end{array}
\end{equation} 
\begin{equation}\label{eq:esquemafrontera2}
	\begin{array}{lc}   
		u_{j,1}=u_{j,0}+k g(x_j)=, &  j=0,1,\dots,m,
	\end{array}
\end{equation} 
\begin{equation}\label{eq:esquemafrontera3}
	\begin{array}{lc}   
		u_{0,r}=u_{m,r}=0, &  r=0,1,\dots,n.
	\end{array}
\end{equation} 







\section{Dominio de dependencia}

Para el esquema que acabamos de definir intentaremos encontrar las condiciones, en las que nuestra solución se aproxime más fielmente a la realidad. El pensamiento inicial puede ser que a más pequeños elijamos $h$ y $k$ mejores resultados obtendremos, pero esto no es cierto en general. Por ello, se utilizan diversos métodos de análisis de estabilidad y convergencia.\\
En esta sección nos centraremos en un concepto altamente relacionado con el tema, el dominio de dependencia.

\begin{definicion}[label={domdep},nameref={Title or anything else}]{Dominio de dependencia}
	Sea una función $u(x,t)$ y un conjunto $[a,b]\times[c,d]$. El dominio de dependencia de $u$ en un punto arbitrario $(x_1,t_1)$, es el conjunto de puntos de $[a,b]$ necesarios para dar la solución de $u$ en $(x_1,t_1)$.
	
\end{definicion}
Como vemos, este concepto no solo estará definido para entornos discretos como lo que hemos estado tratando hasta ahora. Véase que para cada punto del mallado \ref{{Mallado}} $(x_j,t_r)$ tendremos un dominio de dependencia asociado.\\

Es importante remarcar que el dominio de dependencia no es fácilmente calculable, de hecho en muchos casos no se obtiene en la práctica, pero es una herramienta muy útil para comprender las situaciones que se pueden dar en nuestro esquema. Nuestro objetivo será que los puntos del mallado que hemos utilizado para aproximar la solución, contengan íntegramente al dominio de dependencia.\\

Lo ilustramos con las siguiente figuras, utilizando como ejemplo nuestro esquema concreto.


\begin{figure}[!ht]
	
	\centering
	\includegraphics[scale=0.45]{UsadosPaso.png}
	\caption{Puntos que usamos para aproximar  $u(x_j,t_r).$}
\end{figure}

A su vez para aproximar la solución de cada uno de los puntos coloreados de negro, necesitaremos de los anteriores, por lo tanto:

\newpage

\begin{figure}[!ht]
	\centering
	\includegraphics[scale=0.45]{UsadosTodos.png}
	\caption{Todos los puntos que se usan para aproximar la solución de $(x_j,t_r)$.}
	\label{fig:Puntosusados}
\end{figure}

Siendo la recta coloreada e azul, $\overline{QR}$, se podrían dar dos casos\\
Que el dominio de dependencia quedase en el interior de los puntos de $[a,b]$ utilizados en el esquema en diferencias finitas (Coloreados de verde):

\begin{figure}[!ht]
	\centering
	\includegraphics[scale=0.45]{DominioDependenciaconvergente.png}
	\caption{En este caso si hay un cambio en cualquier punto de la recta $\overline{QR}$, los puntos verdes lo captarían, al contener íntegramente a la misma.}
	\label{fig:Convergencia}
\end{figure}

Que el dominio de dependencia quedase fuera de los puntos $[a,b]$ utilizados (verdes):

\begin{figure}[!ht]
	\centering
	\includegraphics[scale=0.45]{DominioDependencianoconvergente.png}
	\caption{En este caso, si se da un cambio en la zona de la recta azul exterior a los puntos verdes, estos no lo captarían y por lo tanto la solución no variaría.}
	\label{fig:noConvergencia}
\end{figure}

La situación más favorable, y por tanto la que busquemos, para nuestro esquema será la primera. En ese caso, al menos no tendremos el tipo de errores comentados en la Figura \ref{fig:noConvergencia}. 







\section{Consistencia}

Para poder comprobar el orden del esquema que hemos elegido \eqref{eq:ondadespejado} vamos a hacer un análisis de la consistencia, que comenzaremos separando la ecuación \eqref{eq:ondametodo} de la siguiente forma,
$$\underbrace{\frac{u(j,r+1)-2u(j,r)+u(j,r-1)}{k^2}}_{(1)}-c^2\underbrace{\frac{u(j+1,r)-2u(j,r)+u(j-1,r)}{h^2}}_{(2)}=0.$$

Haremos ahora el desarrollo de Taylor para cada una de las componentes anteriores,denotando para las derivadas a partir de orden dos  $u_{xxx}=u_{3x}$ y $u_{ttt}=u_{3t}$ respectivamente. Suponiendo que nuestra solución $u$ sea suficientemente regular, es decir, que se pueda derivar tantas veces como haga fatal obtendremos.
\begin{equation*}
	\begin{split}
		u(j+1,r)=&\ u+hu_{x}+h^2\frac{u_{xx}}{2}+h^3\frac{u_{3x}}{3!}+h^4\frac{u_{4x}}{4!}+h^5\frac{u_{5x}}{5!}+O(h^6),\\
		u(j-1,r)=&\ u-hu_{x}+h^2\frac{u_{xx}}{2}-h^3\frac{u_{3x}}{3!}+h^4\frac{u_{4x}}{4!}-h^5\frac{u_{5x}}{5!}+O(h^6),\\
		u(j,r+1)=&\ u+ku_{t}+k^2\frac{u_{tt}}{2}+k^3\frac{u_{3t}}{3!}+k^4\frac{u_{4t}}{4!}+k^5\frac{u_{5t}}{5!}+O(k^6),\\
		u_(j,r-1)=&\ u-ku_{t}+k^2\frac{u_{tt}}{2}-k^3\frac{u_{3t}}{3!}+k^4\frac{u_{4t}}{4!}-k^5\frac{u_{5t}}{5!}+O(k^6),\\ 
		u(j,r)\ \ =&\ u.
	\end{split}
\end{equation*}

Sustituyendo en (1) y (2), obtendremos:
\begin{equation*}
	\begin{split}
		(1)=&u_{tt}+2\frac{k^2 u_{4t}}{4!}+2\frac{k^4 u_{6t}}{6!}+O(h^6),\\
		(2)=&u_{xx}+2\frac{h^2 u_{4x}}{4!}+2\frac{h^4 u_{6x}}{6!}+O(k^6).
	\end{split}
\end{equation*}

Sustituyendo en nuestro esquema nos quedará:

\begin{equation*}
	\begin{split}
		T_{h,k}u:=&u_{tt}+2\frac{k^2 u_{4t}}{4!}+2\frac{k^4 u_{6t}}{6!}-c^2u_{xx}-2c^2\frac{h^2 u_{4x}}{4!}-2c^\frac{h^4 u_{6x}}{6!}\dots=\\
		=&u_{tt}+2\frac{k^2 u_{4t}}{4!}-c^2u_{xx}-2c^2\frac{h^2 u_{4x}}{4!}+O(k^4)+O(h^4).
	\end{split}
\end{equation*}

Como estamos evaluando la solución exacta en cada punto tendremos $u_{tt}=c^2u_{xx}$, entonces
\begin{equation*}
	\begin{split}
		\ &u_{ttt}=c^2u_{xxt},\\
		\ &u_{tttt}=c^2u_{xxtt}.
	\end{split}
\end{equation*}

Por otro lado,
\begin{equation*}
	\begin{split}
		\ &c^2u_{xxx}=u_{ttx},\\
		\ &c^2u_{xxx}=u_{ttxx}.
	\end{split}
\end{equation*}

De aquí deducimos, $u_{4x}=\frac{u_{4t}}{c^4}$ y por tanto:

\begin{equation*}
	\begin{split}
		T_{h,k}u=&u_{tt}+2\frac{k^2 u_{4t}}{4!}-c^2u_{xx}-2c^2\frac{h^2 u_{4x}}{4!}+O(k^4)+O(h^4) = \\9
		=&2\frac{k^2 u_{4t}}{4!}-2c^2\frac{h^2 u_{4t}}{4!c^4}+O(k^4)+O(h^4)=\\
		=& \frac{2}{4!}(k^2-\frac{h^2}{c^2})u_{4t}+O(k^4)+O(h^4)=\\
		=& O(k^2)+O(h^2).		
	\end{split}
\end{equation*}

Así hemos comprobado que el esquema tiene orden de consistencia dos en espacio y en tiempo.\\






\section{Análisis de Von Neumann}
\label{sec:VonNeumann}

En la utilización de métodos multipaso, como el esquema que nos centramos en este trabajo, los errores globales finalmente observados pueden ser mucho mayores de lo que podría esperarse a partir del orden de consistencia local estudiado anteriormente. Esto es debido a que en el error global interviene un aumento del error que se propaga y que, a menudo, incluso se incrementa al disminuir la longitud de paso. Puede estar relacionado con varias factores como el método de inicialización, el truncamiento local y errores de redondeo. Esto se conoce como \textbf{inestabilidad}.

En esta sección nos centraremos en el análisis de Estabilidad de Fourier o Von Neumman. Este aunque no garantizará la estabilidad total del esquema, suele dar muy buenos resultados en la practica, y es el más empleado.\\
Podemos encontrar diversas notaciones y formas de hacer este análisis en libros clásicos y modernos, véase \cite{Software, smith1988analisis}.\\

Comenzamos relacionando cada solución numérica del esquema con la solución exacta y el error del mismo, de la forma:
\begin{equation}\label{eq:num,ex,error}
	u_{j,r}=u(x_j,t_r)+\varepsilon_{j,r}
\end{equation}
donde $\varepsilon_{j,r}$ denotará el error en cada uno de los puntos del retículo que hemos formado.\\


Ahora  vamos a aplicarlo a la ecuación de onda, para profundizar en la estabilidad del esquema \eqref{esquemacompletoonda}. Haciendo uso del termino del error como hemos visto en \eqref{eq:num,ex,error}, lo sustituimos en el esquema, esta vez utilizando \eqref{eq:ondametodo}.

\begin{equation*}
	\begin{split}
			&\left(\frac{u(x_j,t_{r+1}) - 2u(x_{j},t_{r}) +u(x_j,t_{r-1})}{k^2} - c^2 \frac{u(x_{j+1},t_{r}) - 2u(x_{j},t_{r}) +u(x_{j-1},t_{r})}{h^2}\right)+\\
			&+\left(\frac{\varepsilon_{j,r+1} - 2v_{j,r} +\varepsilon_{j,r-1}}{k^2} - c^2 \frac{\varepsilon_{j+1,r} - 2\varepsilon_{j,r} +\varepsilon_{j-1,r}}{h^2}\right)=0 .
	\end{split}
\end{equation*}

Como cualquier esquema numérico lineal se satisface de manera exacta por $u(x_{j},t_{r})$, los errores también serán soluciones de la ecuación discretizada, obteniendo.\\

\begin{equation*}
	\frac{\varepsilon_{j,r+1} - 2v_{j,r} +\varepsilon_{j,r-1}}{k^2} - c^2 \frac{\varepsilon_{j+1,r} - 2\varepsilon_{j,r} +\varepsilon_{j-1,r}}{h^2}=0.
\end{equation*}

Tomando la solución de tipo onda $\varepsilon_{j,r}=g^re^{ij\beta h}$ donde i es la unidad imaginaria, g denota el factor de amplitud y $\beta$ se corresponderá con el número de onda de la ecuación de Fourier.
Vamos a sustituirlo en la ecuación anterior, quedando:

\begin{equation*}
	g^{r+1}e^{ij\beta h} = \mu ^2( g^{r}e^{i(j+1)\beta h}+g^{r}e^{i(j-1)\beta h})  +2(1-\mu^2)  g^{r}e^{ij\beta h} -  g^{r-1}e^{ij\beta h}.
\end{equation*}

Dividiendo entre $g^{r-1}e^{ij\beta h}$:

\begin{equation*}
	\begin{split}
		g^{2} = &\ \mu ^2( ge^{i\beta h}+ge^{-i\beta h})  + 2(1-\mu^2)  g - 1, \\
		0\ = &\ g^{2}- \mu ^2( ge^{i\beta h}+ge^{-i\beta h})  - 2(1-\mu^2)g + 1 .
	\end{split}
\end{equation*}

Usando las identidades trigonométricas $e^{ix}+e^{-ix}=2 cos(x)$ y $1-cos(x)=2sin^2(\frac{x}{2})$ obtenemos,

\begin{equation*}
	\begin{split}
		0\ = &\ g^{2}- 2\mu ^2cos(\beta h)g  - 2(1-\mu^2)g + 1, \\
		\ = &\ g^{2}- 2\mu ^2cos(\beta h)g  +2\mu^2g - 2g +1,\\
		\ = &\ g^{2}+ 2g(1+\mu ^2(1-cos(\beta h))) + 1,\\
		\ = &\ g^{2}+ 2\left(2\mu ^2sin^2\left(\frac{\beta h}{2}\right)-1\right)g+ 1.
	\end{split}
\end{equation*}

Podemos ahora tratarlo como una ecuación de segundo grado, es decir, tomando \\ 
$A=\left(1-2\mu ^2sin^2\left(\frac{\beta h}{2}\right)\right)$ vemos que nos quedaría,

\begin{equation*}
	\begin{split}
		g= &\frac{2A\pm \sqrt{(-2A)^2-4}}{2}=A\pm \sqrt{A^2-1}=\\
		= &1-2\mu ^2sin^2\left(\frac{\beta h}{2}\right) \pm \sqrt{\left(1-2\mu ^2sin^2\left(\frac{\beta h}{2}\right)\right)^2-1}.
	\end{split}
\end{equation*}



Al ser $g$ el factor de ampliación, es una relación del espacio y el tiempo y si se alejase demasiado de $0$, las perturbaciones se amplificarán con el tiempo. Por lo tanto necesitaremos $|g|\leq 1 $, es decir, vamos a estudiar una condición suficiente (llamada condición CFL) para que
 
$$\left| A\pm \sqrt{A^2-1} \right|\leq 1. $$
 	
Vamos a ver que pasará dependiendo de los valores posibles de $A$. Como $2\mu ^2sin^2\left(\frac{\beta h}{2}\right) \geq 0$ tendremos que $A\leq1$.

\begin{itemize}
	\item Si $A<-1$:\\ La solución $g = A-\sqrt{A^2-1}<-1$ y por lo tanto siempre se da $|g|>1$ y el esquema será en cualquier caso inestable.
	
	\item Si $ -1\leq A\leq 1$:\\ Definimos $s^2 \triangleq sin^2\left(\frac{\beta h}{2}\right)$, con esto tenemos
	$$0\leq s^2\leq 1,$$
	luego,
	$$0\leq 2\mu^2s^2\leq 2\mu^2,$$
	$$0\geq -2\mu^2s^2\geq -2\mu^2,$$
	$$1\geq 1- 2\mu^2s^2\leq\underbrace{1-2\mu^2\geq-1}_{(1)}.$$
	Veamos cual es la condición necesaria para que se de $(1)$,
	 $$1-2\mu^2\geq-1,$$
	 $$2\mu^2\leq2,$$
	 \begin{equation}\label{mu}
	 	\mu\leq 1,
	 \end{equation}
	 llegamos a que para que el esquema sea estable necesitamos que se de esta última condición $\mu\leq 1$, la condición CFL.		
\end{itemize}

Por lo tanto, nuestro esquema será condicionalmente estable.\\

Volviendo al concepto de dominio de dependencia \ref{domdep}, tal y como se extrae de \citep{AnIntroduction}, cuanto más nos acerquemos a la igualdad  ($\mu=1$), cubriremos de manera mas óptima el dominio de dependencia con nuestra aproximación. Siempre respetando la condición CFL.\\


En la comparativa del capítulo siguiente, variaremos $\mu$, para ilustrar como afecta de manera muy positiva a la estabilidad de las soluciones, el análisis realizado.





\section{Resolución numérica para las soluciones de tipo viajero}	
\label{Ondaviajera}
Tal y como comentamos en la sección \ref{sec:Ecuaciontransporte} de la ecuación de onda se puedesn obtener dos soluciones de tipo onda viajera \eqref{eq:propagacion}. Ahora nos centraremos en implementar numéricamente dichas soluciones.\\

Querremos ver dichas soluciones en cada uno de nuestro puntos del mallado, para ello llamaremos a las aproximaciones de las mismas en cada unos de los puntos como

\begin{equation*}
	\begin{split}
		w^+(x_j,t_r)&=p_+(x_j-ct_r),\\
		w^-(x_j,t_r)&=p_-(x_j+ct_r).
	\end{split}
\end{equation*} 

Ahora tendremos que la aproximación de la solución de $u$ será,
\begin{equation}\label{eq:aproximacionw}
	u_{j,r}=w^+_{j,r}+w^-_{j,r}.
\end{equation}

Partiendo de las representaciones de las soluciones \eqref{repp-} y \eqref{repp+}, aproximaremos $w^+_{j,r}$ y $w^-_{j,r}$. Esto lo haremos primeramente separando en dos la integral, trabajemos con $p_-(x_j+ct_r)$:

\begin{equation*}
	\begin{split}
		p_-(x_j+ct_r)&=\frac{1}{2}f(x_j+ct_r) + \frac{1}{2c}\int_{0}^{x_j+ct_r}g(s)\partial s =\\
		&= \frac{1}{2}f(x_j+ct_r) + \frac{1}{2c}\int_{0}^{x_j}g(s)\partial s + \frac{1}{2c}\int_{x_j}^{x_j+ct_r}g(s)\partial s.
	\end{split}
\end{equation*}

Realizamos una aproximación de cada una de las integrales utilizando el método del trapecio y los puntos ya definidos en el mallado. El tamaño de paso en la primera integral será $h$, y en la segunda será $ck$, por tanto la aproximación es.
\begin{equation*}
	\begin{split}
		w^-_{j,r}&= \frac{1}{2}f(x_j+ct_r) + \frac{h}{4c}\left(g(x_0)+2\sum_{i=1}^{j-1}g(x_i)+ g(x_j)\right)\\
		& + \frac{ck}{4c}\left(g(x_j+ct_0)+2\sum_{i=1}^{r-1}g(x_j+ct_i)+ g(x_j+ct_r)\right).
	\end{split}
\end{equation*}

Por otro lado trabajando con $p_+(x_j+ct_r)$, por como hemos definido las aproximaciones \eqref{eq:aproximacionw} podemos simplemente utilizar:
\begin{equation*}
	\begin{split}
		w^+_{j,r}=u_{j,r}-w^-_{j,r}
	\end{split}
\end{equation*}

Con esto ya podríamos implementar las soluciones en caso de que $g$ no sea integrable. Más adelante, en la sección \ref{sec:solondaviajera}, ilustraremos la relación de esta soluciones, con la aproximación numérica.






\section{Ley de energía discreta}
\label{energiadiscreta}

En este punto nos preguntamos como se traducirían esta ley de energía a nuestro esquema. En este caso al ser el esquema discreto, tendremos que usar la definición de suma por partes \ref{Inner},
en lugar de la del producto interior anteriormente utilizada en la sección \ref{sec:energiaondas}.\\

 Vamos a comenzar tomando como dominio mallado \ref{Mallado}, sabiendo que queremos hacer la suma por partes en el eje de la posición definimos $D$ los puntos del mismo. Veremos cuales son las condiciones que deberán cumplir nuestro esquema, utilizando la función $\delta$ definida en \ref{defdelta}, será.

$$\left(\delta_tu,\delta_{tt}u\right)_D= c^2 \left<\delta_t u,\delta_{xx}u\right)_D. $$

Siguiendo la notación que tomabamos en \ref{SumaPartes}, para cada $r=1,\dots,n$ tendremos:

\begin{equation}\label{energia}
	\left(\delta_tu_{\cdot,r},\delta_{tt}u_{\cdot,r}\right)_D= c^2 \left(\delta_t u_{\cdot,r},\delta_{xx}u_{\cdot,r}\right)_D. 
\end{equation}

Ahora para desarrollar la parte derecha de la igualdad usaremos la observación \ref{derivada2} y posteriormente la definición \ref{SumaPartes}.


\begin{equation}\label{deltaxx}
	\begin{split}
		\left(\delta_t u_{\cdot,r},\delta_{xx}u_{\cdot,r}\right)_{L^2(D)} &\underset{\ref{derivada2}}{=} \left(\delta_t u_{\cdot,r},\delta_{x^+x^-}u_{\cdot,r}\right)_{L^2(D)},\\
		\underset{\eqref{eq:rep2}}{=}-\left(\delta_{x^+}\delta_{t} u_{\cdot,r},\delta_{x^+}u_{\cdot,r}\right)_{L^2(D)} - (\delta_{t} &u_{0,r})(\delta_{x^-}u_{-1,r})- (\delta_{t} u_{m+1,r})(\delta_{x^-}u_{m,r}).
	\end{split}
\end{equation}

Insertando esto en la ecuación \eqref{energia} nos quedaría:
$$\left(\delta_tu_{\cdot,r},\delta_{tt}u_{\cdot,r}\right)_D + c^2 \left(\delta_t u_{\cdot,r},\delta_{x+}\delta_{t}u_{\cdot,r}\right)_D= -c^2(\delta_{t} u_{0,r})(\delta_{x^-}u_{-1,r})+ c^2(\delta_{t} u_{m+1,r})(\delta_{x^-}u_{m,r}). $$


Denotando al termino de la derecha como $\mathfrak{b}$ tendremos que
$$\delta_{t+}\mathfrak{h}=\mathfrak{b}.$$

Identificamos los términos, de la energía total $\mathfrak{h}$, energía cinética $\mathfrak{t}$ y energía potencial $\mathfrak{v}$:

\begin{equation*}
	\begin{array}{ccc}   
		\mathfrak{h}= \mathfrak{t}+\mathfrak{v},\ \ \ \ & \mathfrak{t}= \frac{1}{2}||\delta_{t-}u_{\cdot,r}||_D &  \ \ \text{y}\ \ \ \mathfrak{v}= \frac{\mu^2}{2}\left( \delta_{x+}u_{\cdot,r},e_{t-}\delta_{x+}u_{\cdot,r} \right)_D.
		
	\end{array}
\end{equation*}

Y por lo tanto se dará la conservación de energía cuando $\mathfrak{b}=0$, es decir cuando 
\begin{equation}\label{energiacero}
	(\delta_{t} u_{0,r})(\delta_{x^-}u_{-1,r})= (\delta_{t} u_{m+1,r})(\delta_{x^-}u_{m,r}).
\end{equation}

Esto se puede dar de muchas maneras, pero las mas sencillas y estudiadas son que ambas sean cero. Para el lado izquierdo de \eqref{energiacero} se traduciría en:

\begin{equation}\label{primeracond}
	\begin{array}{lc}
		u_{0,r}=0, &   r=0,1,\dots,n,\\
	\end{array} 
\end{equation}
\begin{equation*}
	\text{o}
\end{equation*}
\begin{equation}\label{segundacond}
	\begin{array}{lc}
		\delta_{x^-}u_{0,r} &   r=0,1,\dots,n.\\
	\end{array} 
\end{equation}

Vemos que \eqref{primeracond} se corresponde con la condición de Dirichlet en el borde izquierdo del mallado, esta será la misma condición que dábamos en \eqref{eq:esquemafrontera3}. De la segunda,\eqref{segundacond}, de la definición de \eqref{defdelta} sabemos, $\delta_{x^-}u_{0,r}=\frac{1}{h}\left(u_{0,r}-u_{-1,r}\right)$ y por lo tanto $u_{j,0}= u_{j,-1}$ para $j=0,1,\dots,m$.\\

 En nuestro caso $j =-1$ no se encuentra en el esquema, pero gracias a la igualdad que acabamos de obtener podremos inicializar los puntos de la primera posición en espacio $j=0$ con nuestra expresión \eqref{eq:ondadespejado}, quedando:
\begin{equation*}
	\begin{split}
		u_{0,r+1} &= \mu ^2( u_{1,r}+u_{-1,r})  + 2(1-\mu^2)  u_{0,r} -  u_{0,r-1}\\
		&=\mu ^2( u_{1,r}+u_{0,r})  + 2(1-\mu^2)  u_{0,r} -  u_{0,r-1}\\
		&=\mu ^2u_{1,r}+ (2-\mu^2)u_{0,r} -  u_{0,r-1}
	\end{split}
\end{equation*}

Miramos ahora el lado derecho de la igualdad \eqref{energiacero} e igualando a cero tendremos
\begin{equation}\label{primeracond2}
	\begin{array}{lc}
		u_{m+1,r}=0, &   r=0,1,\dots,n,\\
	\end{array} 
\end{equation}
\begin{equation*}
	\text{o}
\end{equation*}
\begin{equation}\label{segundacond2}
	\begin{array}{lc}
		\delta_{x^-}u_{m,r} &   r=0,1,\dots,n,\\
	\end{array} 
\end{equation}
(AQUÍ EL PROBLEMA ES LA INTERPRETACIÓN DE ESTO. LA PRIMERA CONDICIÓN SE REFIERE A UNA RECTA DE PUNTOS VIRTUALES (queda $u_{m+1,r}=0$) Y LA SEGUNDA UNOS PUNTOS QUE YA TENEMOS DEFINIDOS POR NUESTRO ESQUEMA\eqref{esquemacompletoonda} ($u_{m,r}=u_{m-1,r}$ LO QUE AL METERLO EN EL ESQUEMA \eqref{eq:ondadespejado},ME QUEDA $u_{m,r+1}=(2-\mu^2)u_{m,r} + \mu^2u_{m+1,r}-u_{m,r-1}$) Y AL TENER NODOS VIRTUALES TAMPOCO SE COMO SE COMO CONTINUAR)\\

 En el capítulo siguiente modificaremos estas expresiones obtenidas, para ver que pasa cuando no se da conservación de la energía.


% ----------------------------------------------------------------------